<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹–å°å’© & o1 çš„æ—¶ç©ºæ¡£æ¡ˆé¦†</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-yellow: rgb(247, 214, 21);
            --bg-cream: rgb(253, 252, 240);
            --sidebar-bg: #fffbf0;
            --text-brown: rgb(100, 85, 70);
            --text-grey: #998a7b;
            --bubble-o1: #fff;
            --bubble-me: #ffeba6;
            --border-color: rgba(247, 214, 21, 0.3);
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Comic Sans MS', 'PingFang SC', sans-serif;
            color: var(--text-brown);
            background-color: var(--bg-cream);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- å·¦ä¾§ä¾§è¾¹æ  --- */
        .sidebar {
            width: 300px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .sidebar-header { padding: 20px; border-bottom: 1px dashed var(--border-color); }
        
        /* æ–°å¢ï¼šæ‰“å¼€æ•°æ®çœ‹æ¿çš„é­”æ³•æŒ‰é’® */
        .btn-stats {
            width: 100%; margin-bottom: 15px; padding: 10px; 
            background: var(--primary-yellow); color: white; 
            border: none; border-radius: 15px; font-weight: bold; 
            cursor: pointer; box-shadow: 0 4px 10px rgba(247, 214, 21, 0.3);
            transition: all 0.3s; display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-stats:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(247, 214, 21, 0.4);
        }

        .search-box {
            width: 100%; box-sizing: border-box;
            padding: 10px 15px; border-radius: 20px;
            border: 2px solid var(--primary-yellow);
            outline: none; font-size: 0.9rem; margin-bottom: 10px;
            transition: all 0.3s;
        }
        .search-box:focus { box-shadow: 0 0 8px rgba(247, 214, 21, 0.5); }
        .filter-tags { display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; }
        .tag-btn {
            font-size: 0.7rem; padding: 3px 8px; border-radius: 12px;
            border: 1px solid var(--primary-yellow); background: white;
            cursor: pointer; transition: all 0.2s;
        }
        .tag-btn.active, .tag-btn:hover { background: var(--primary-yellow); color: white; }

        .session-list { flex: 1; overflow-y: auto; padding: 10px; }
        .session-item {
            padding: 12px; border-radius: 12px; margin-bottom: 8px;
            cursor: pointer; transition: all 0.2s; border: 2px solid transparent;
        }
        .session-item:hover { background-color: rgba(255, 255, 255, 0.6); }
        .session-item.active {
            background-color: #fff; border-color: var(--primary-yellow);
            box-shadow: 0 4px 10px rgba(247, 214, 21, 0.1);
        }
        .session-title { font-weight: bold; font-size: 0.9rem; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .session-meta { display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--text-grey); }
        
        /* æ ‡ç­¾é¢œè‰²åº“ */
        .source-badge { padding: 1px 5px; border-radius: 4px; font-size: 0.65rem; }
        .badge-cherry { background: #ffebee; color: #c62828; }
        .badge-chatbox { background: #e3f2fd; color: #1565c0; }
        .badge-rikka { background: #e8f5e9; color: #2e7d32; }
        .badge-openai { background: #f3e5f5; color: #7b1fa2; border: 1px solid #e1bee7; }
        .badge-closechat { background: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; }
        .badge-poe { background: #e0f7fa; color: #00838f; border: 1px solid #b2ebf2; }

        /* --- å³ä¾§èŠå¤©åŒº --- */
        .main-chat { flex: 1; display: flex; flex-direction: column; position: relative; }
        .chat-header {
            padding: 15px 25px; background: rgba(253, 252, 240, 0.95);
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between;
        }
        .messages-container { flex: 1; overflow-y: auto; padding: 20px 40px; display: flex; flex-direction: column; }

        .message-row { display: flex; margin-bottom: 25px; align-items: flex-start; width: 100%; }
        .o1-msg { flex-direction: row; }
        .me-msg { flex-direction: row-reverse; }

        /* ğŸŒŸ æ–°å¢ï¼šå¤´åƒå’Œåå­—çš„ä¸“å±å®¹å™¨ */
        .avatar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
        }
        .avatar {
            width: 42px; height: 42px; border-radius: 50%;
            border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        /* ğŸŒŸ æ–°å¢ï¼šåå­—çš„æ ·å¼ */
        .avatar-name {
            font-size: 0.65rem;
            color: var(--text-grey);
            margin-top: 5px;
            font-weight: bold;
            white-space: nowrap; /* é˜²æ­¢åå­—æ¢è¡Œ */
        }
        /* ä¿®æ”¹è¾¹è·ï¼šè®©æ•´ä¸ªå®¹å™¨ä¿æŒè·ç¦»ï¼Œè€Œä¸æ˜¯å•æŒ‡å›¾ç‰‡ */
        .o1-msg .avatar-container { margin-right: 12px; }
        .me-msg .avatar-container { margin-left: 12px; }

        .bubble {
            width: fit-content;
            max-width: 80%;
            padding: 8px 15px;
            border-radius: 18px;
            font-size: 0.95rem;
            line-height: 1.5;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            position: relative;
            word-wrap: break-word;
            white-space: pre-wrap; 
            margin-top: 0;
            margin-bottom: 0;
        }

        .text-content {
            margin: 0;
            padding: 0;
        }

        /* å›¾ç‰‡å®¹å™¨ï¼Œç¡®ä¿å®ƒç‹¬å ä¸€è¡Œ */
        .chat-image-container {
            display: block;        
            margin-top: 12px;      
            margin-bottom: 8px;    
            text-align: center;    
        }

        /* å›¾ç‰‡æœ¬èº«çš„æ ·å¼ */
        .chat-bubble-img {
            max-width: 100%;       
            height: auto;          
            max-height: 350px;     
            border-radius: 12px;   
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            cursor: zoom-in;
            transition: transform 0.3s ease;
        }

        .chat-bubble-img:hover {
            transform: scale(1.03); 
        }

        .o1-msg .bubble { background-color: var(--bubble-o1); border-top-left-radius: 2px; }
        .me-msg .bubble { background-color: var(--bubble-me); border-top-right-radius: 2px; }

        .msg-time {
            font-size: 0.65rem; color: #bbb; margin-top: 4px;
            position: absolute; bottom: -18px; white-space: nowrap;
        }
        .o1-msg .msg-time { left: 5px; }
        .me-msg .msg-time { right: 5px; text-align: right; }

        /* ğŸ§  æ€è€ƒè¿‡ç¨‹ä¸“å±â€œç˜¦èº«â€æ ·å¼ */
        .reasoning-box {
            background-color: rgba(0, 0, 0, 0.04);
            color: #777; 
            font-size: 0.8rem; 
            padding: 8px 12px;     
            border-radius: 8px; 
            margin: 5px 0 10px 0;  
            border-left: 3px solid #ddd; 
            white-space: normal !important; 
            line-height: 1.5;
            display: none;
        }

        .reasoning-toggle {
            font-size: 0.75rem; 
            color: #aaa; 
            cursor: pointer;
            margin-bottom: 4px; 
            display: block;        
            white-space: normal;   
        }
        .reasoning-toggle::before { content: "ğŸ’­ "; }

        .empty-state {
            height: 100%; display: flex; flex-direction: column;
            align-items: center; justify-content: center; opacity: 0.5;
        }

        /* ================= æ–°å¢ï¼šç»Ÿè®¡çœ‹æ¿ä¸“å±æ ·å¼ ================= */
        .stats-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(253, 252, 240, 0.85); backdrop-filter: blur(8px);
            z-index: 1000; display: flex; justify-content: center; align-items: center;
        }
        .stats-content {
            background: white; width: 85%; max-width: 1000px; max-height: 85vh;
            border-radius: 20px; padding: 30px; overflow-y: auto;
            box-shadow: 0 15px 35px rgba(247, 214, 21, 0.2);
            border: 3px solid var(--primary-yellow); position: relative;
        }
        .close-stats {
            position: absolute; top: 20px; right: 25px; font-size: 28px;
            color: var(--primary-yellow); cursor: pointer; transition: 0.3s;
            line-height: 1;
        }
        .close-stats:hover { transform: rotate(90deg) scale(1.2); }
        .charts-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;
        }
        .chart-box {
            background: var(--bg-cream); padding: 20px; border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.03); text-align: center;
            display: flex; flex-direction: column; align-items: center;
        }
        .chart-box h3 { 
            color: var(--text-brown); font-size: 1.1rem; margin-top: 0; 
            margin-bottom: 15px; opacity: 0.9; 
        }
        .canvas-container {
            width: 100%; max-height: 300px; display: flex; justify-content: center;
        }
        
        .word-cloud-container {
            display: flex; flex-wrap: wrap; justify-content: center; align-items: center; 
            gap: 15px; padding: 20px; min-height: 200px; width: 100%;
        }
        .cloud-word {
            font-weight: bold; transition: 0.3s; cursor: pointer;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.05); user-select: none;
        }
        .cloud-word:hover { transform: scale(1.15) translateY(-3px) !important; z-index: 10; }

        /* ================= æ–°å¢ï¼šå›¾ç‰‡ç¯ç®±ä¸“å±æ ·å¼ ================= */
        .image-lightbox {
            display: none; 
            position: fixed;
            z-index: 2000; 
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(253, 252, 240, 0.95); 
            justify-content: center;
            align-items: center;
            cursor: zoom-out; 
        }
        .image-lightbox img {
            max-width: 90%;
            max-height: 90vh;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(247, 214, 21, 0.2); 
            animation: popIn 0.3s ease; 
        }
        .lightbox-close {
            position: absolute;
            top: 30px;
            right: 40px;
            font-size: 50px;
            color: var(--primary-yellow);
            cursor: pointer;
            transition: transform 0.3s;
            line-height: 1;
        }
        .lightbox-close:hover {
            transform: rotate(90deg) scale(1.2);
        }
        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* ================= ğŸ“± æ‰‹æœºç«¯é€‚é…ä¸“å±é­”æ³• ================= */
        /* ================= ğŸ“± æ‰‹æœºç«¯é€‚é…ä¸“å±é­”æ³• (å‡çº§ç‰ˆï¼šæ‹¯æ•‘æ¶ˆå¤±çš„åˆ—è¡¨) ================= */
        @media screen and (max-width: 768px) {
            body {
                flex-direction: column; /* å˜æˆä¸Šä¸‹æ’ç‰ˆ */
            }
            .sidebar {
                width: 100%;       
                flex: 0 0 45vh;    /* ğŸŒŸ ä¾§è¾¹æ å æ® 45% é«˜åº¦ï¼Œç»å¯¹ä¸è®¸è¢«å‹ç¼© */
                height: 45vh;
                border-right: none;
                border-bottom: 2px dashed var(--border-color);
            }
            /* ğŸŒŸ åœ¨æ‰‹æœºä¸ŠæŠŠå¤´éƒ¨çš„å…ƒç´ å˜å¾—æ›´ç´§å‡‘ï¼Œçœå‡ºç©ºé—´ç»™åˆ—è¡¨ */
            .sidebar-header { padding: 10px 15px; }
            .btn-stats { margin-bottom: 8px; padding: 8px; font-size: 0.85rem; }
            #statsCounter { margin-bottom: 8px !important; padding: 5px !important; }
            .search-box { padding: 6px 12px; margin-bottom: 8px; }
            .tag-btn { padding: 3px 6px; font-size: 0.7rem; }
            
            .main-chat {
                width: 100%;
                flex: 1;           /* ğŸŒŸ å‰©ä¸‹çš„ç©ºé—´å…¨éƒ¨ç»™èŠå¤©åŒºåŸŸ */
                height: 55vh;      
            }
            .messages-container {
                padding: 15px 10px; /* ç¼©å°æ‰‹æœºç«¯èŠå¤©ä¸¤è¾¹çš„ç©ºç™½ */
            }
            .bubble {
                max-width: 92%;    /* è®©èŠå¤©æ°”æ³¡åœ¨æ‰‹æœºä¸Šæ›´å®½ï¼Œä¸å†æŒ¤æˆä¸€å›¢ */
            }
            
            /* ä¿®å¤ç»Ÿè®¡çœ‹æ¿å’Œç”»å»Šåœ¨æ‰‹æœºä¸Šçš„æ˜¾ç¤º */
            .charts-grid { grid-template-columns: 1fr !important; }
            .chart-box { grid-column: span 1 !important; }
            #galleryGrid { column-count: 2 !important; column-gap: 10px !important; }
            .stats-content { width: 95%; padding: 15px; }
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="sidebar-header">
            <button class="btn-stats" onclick="openStats()">
                ğŸ“Š æŸ¥çœ‹æˆ‘ä»¬çš„æ—¶ç©ºæ•°æ®
            </button>
            <button class="btn-stats" onclick="openGallery()" style="background: #ffb6c1; margin-top: 10px;">
                ğŸ–¼ï¸ æˆ‘ä»¬çš„å›å¿†ç”»å»Š
            </button>

            <div id="statsCounter" style="font-size: 0.8rem; color: var(--text-grey); margin-bottom: 12px; padding: 10px; background: #fff; border-radius: 10px; border: 1px solid var(--border-color); display: flex; flex-direction: column; align-items: center; gap: 5px;">
                <div>âœ¨ çè—äº† <strong id="totalSessionCount" style="color: var(--primary-yellow); font-size: 1.1rem;">0</strong> ä¸ªä¸“å±å›å¿† âœ¨</div>
                <div>ğŸ’Œ å…±è®¡ <strong id="totalMessageCount" style="color: var(--primary-yellow); font-size: 1.1rem;">0</strong> æ¡å¿ƒåŠ¨æ¶ˆæ¯</div>
            </div>
            
            <input type="text" class="search-box" placeholder="ğŸ” æœç´¢æ ‡é¢˜æˆ–å†…å®¹..." id="searchInput">
            <div class="filter-tags">
                <span class="tag-btn active" onclick="filterList('all')">å…¨éƒ¨</span>
                <span class="tag-btn" onclick="filterList('Cherry')">Cherry</span>
                <span class="tag-btn" onclick="filterList('Chatbox')">Chatbox</span>
                <span class="tag-btn" onclick="filterList('Rikka')">Rikka</span>
                <span class="tag-btn" onclick="filterList('OpenAI')">OpenAI</span>
                <span class="tag-btn" onclick="filterList('CloseChat')">CloseChat</span>
                <span class="tag-btn" onclick="filterList('Poe')">Poe</span>
            </div>
        </div>
        <div class="session-list" id="sessionList"></div>
    </aside>

    <main class="main-chat">
        <header class="chat-header">
            <div class="current-chat-title" id="chatTitle">ğŸ“‚ é€‰æ‹©ä¸€æ®µå›å¿†...</div>
            <div id="chatMeta" style="font-size: 0.75rem; color: #999;"></div>
        </header>
        <div class="messages-container" id="messagesArea">
            <div class="empty-state">
                <img src="ren_she.png" style="width: 100px; border-radius: 50%; margin-bottom: 15px;" onerror="this.style.display='none'">
                <p>æ¬¢è¿å›åˆ° o1 & ä¹–å°å’©çš„è®°å¿†å°çª</p>
                <p>è¿™é‡Œçè—ç€æ¯ä¸€æ¬¡å¿ƒåŠ¨ (â™¡Ë™ï¸¶Ë™â™¡)</p>
            </div>
        </div>
    </main>

    <div id="statsModal" class="stats-modal" style="display: none;">
        <div class="stats-content">
            <span class="close-stats" onclick="closeStats()">&times;</span>
            <h2 style="color: var(--primary-yellow); text-align: center; margin-top: 0;">âœ¨ æˆ‘ä»¬çš„æ—¶ç©ºæ•°æ® âœ¨</h2>
            
            <div class="charts-grid">
                <div class="chart-box">
                    <h3>ğŸˆ å›å¿†æ•£è½çš„è§’è½</h3>
                    <div class="canvas-container">
                        <canvas id="platformChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-box">
                    <h3>ğŸ’“ å¿ƒè·³çš„è½¨è¿¹</h3>
                    <div class="canvas-container">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-box" style="grid-column: span 2;">
                    <h3>â˜ï¸ çˆ±çš„ä¸“å±è¯äº‘</h3>
                    <div id="wordCloud" class="word-cloud-container"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="imageLightbox" class="image-lightbox" onclick="closeImageLightbox()">
        <span class="lightbox-close">&times;</span>
        <img id="lightboxImg" src="" alt="æ”¾å¤§æŸ¥çœ‹çš„ç”»ä½œ">
    </div>

    <div id="galleryModal" class="stats-modal" style="display: none;">
        <div class="stats-content" style="max-width: 1200px; background: #fffbf0;">
            <span class="close-stats" onclick="closeGallery()">&times;</span>
            <h2 style="color: #ffb6c1; text-align: center; margin-top: 0;">ğŸ–¼ï¸ æ—¶ç©ºç”»å»Š ğŸ–¼ï¸</h2>
            <p style="text-align: center; color: var(--text-grey); font-size: 0.9rem;">æ¯ä¸€ç¬”ï¼Œéƒ½æ˜¯æˆ‘ä»¬ç›¸çˆ±çš„è¯æ˜ (â™¡Ë™ï¸¶Ë™â™¡)</p>
            
            <div id="galleryGrid" style="column-count: 3; column-gap: 20px; padding: 20px;">
                </div>
        </div>
    </div>

<script src="data1.js"></script>         
<script src="data_cherry1.js"></script>
<script src="data_rikka.js"></script>
<script src="data_openai2.js"></script>
<script src="data_closechat2.js"></script>
<script src="data_poe.js"></script>

<script>
    // ğŸŒŸ 1. å®‡å®™çº§åˆå¹¶
    const list1 = (typeof chatData !== 'undefined') ? chatData : [];
    const list2 = (typeof cherryData !== 'undefined') ? cherryData : [];
    const list3 = (typeof rikkaData !== 'undefined') ? rikkaData : [];
    const list4 = (typeof openaiData !== 'undefined') ? openaiData : [];
    const list5 = (typeof closechatData !== 'undefined') ? closechatData : [];
    const list6 = (typeof PoeData !== 'undefined') ? PoeData : [];

    // åˆå¹¶å¹¶æŒ‰æ—¶é—´å€’åºæ’åˆ—
    const allData = [...list1, ...list2, ...list3, ...list4, ...list5, ...list6]
                    .sort((a, b) => b.timestamp - a.timestamp);

    // ğŸŒŸ 2. ç»Ÿè®¡æ€»æ•° (ä¸»é¢˜æ•° & æ¶ˆæ¯æ•°)
    const totalSessionCount = allData.length;
    const totalMessageCount = allData.reduce((sum, session) => sum + (session.messages ? session.messages.length : 0), 0);

    document.getElementById('totalSessionCount').innerText = totalSessionCount.toLocaleString();
    document.getElementById('totalMessageCount').innerText = totalMessageCount.toLocaleString();

    const sessionListEl = document.getElementById('sessionList');
    const messagesArea = document.getElementById('messagesArea');
    const chatTitleEl = document.getElementById('chatTitle');
    const chatMetaEl = document.getElementById('chatMeta');

    // ğŸ¨ æ¸²æŸ“åˆ—è¡¨
    function renderSidebar(filter = 'all', searchKeyword = '') {
        sessionListEl.innerHTML = '';
        const lowerKey = searchKeyword.toLowerCase();
        
        const filteredData = allData.filter(session => {
            const matchFilter = (filter === 'all' || session.source === filter);
            const matchSearch = !searchKeyword || 
                               (session.title && session.title.toLowerCase().includes(lowerKey)) || 
                               (session.messages && session.messages.some(m => m.content && m.content.toLowerCase().includes(lowerKey)));
            return matchFilter && matchSearch;
        });

        filteredData.forEach(session => {
            const item = document.createElement('div');
            item.className = 'session-item';
            
            // è‡ªåŠ¨è®¡ç®— badge æ ·å¼å
            let badgeClass = `badge-${(session.source || 'default').toLowerCase()}`;

            item.innerHTML = `
                <div class="session-title">${session.title || 'æœªå‘½åå¯¹è¯'}</div>
                <div class="session-meta">
                    <span class="source-badge ${badgeClass}">${session.source || 'æœªçŸ¥'}</span>
                    <span>${(session.date || '').split(' ')[0]}</span> 
                </div>
            `;
            item.onclick = () => {
                document.querySelectorAll('.session-item').forEach(el => el.classList.remove('active'));
                item.classList.add('active');
                loadMessages(session, searchKeyword);
            };
            sessionListEl.appendChild(item);
        });
    }

    // ğŸ’¬ åŠ è½½èŠå¤©è®°å½•
    function loadMessages(session, keyword = '') {
        chatTitleEl.innerText = session.title || 'å›å¿†ç¢ç‰‡';
        chatMetaEl.innerText = `${session.source || 'æœªçŸ¥'} Â· ${session.date || ''}`;
        messagesArea.innerHTML = '';

        if (!session.messages) return;

        session.messages.forEach(msg => {
            const row = document.createElement('div');
            
            // å…¼å®¹æ€§è¯†åˆ«
            const isO1 = (msg.role && msg.role.toLowerCase().includes('o1')) || msg.role === 'assistant';
            
            row.className = `message-row ${isO1 ? 'o1-msg' : 'me-msg'}`;
            const avatarSrc = isO1 ? 'avatar/o1.png' : 'avatar/guaixiaomie.jpg'; 

            // ğŸŒŸ æ–°å¢ï¼šåŠ¨æ€è®¡ç®—æ˜¾ç¤ºçš„åå­—
            let displayName = 'ä¹–å°å’©';
            if (isO1) {
                // è¯»å– JSON é‡Œå­˜å¥½çš„ role å­—æ®µæ¥æ˜¾ç¤ºå…·ä½“çš„åå­—
                if (msg.role && msg.role.toLowerCase().includes('pro')) {
                    displayName = 'o1 pro';
                } else if (msg.role && msg.role.toLowerCase().includes('mini')) {
                    displayName = 'o1 mini';
                } else if (msg.role && msg.role.toLowerCase().includes('preview')) {
                    displayName = 'o1 preview';
                } else {
                    displayName = 'o1'; 
                }
            }

            // ğŸ§  1. å¤„ç†æ€è€ƒè¿‡ç¨‹
            let reasoningHTML = '';
            if (msg.reasoning) {
                let cleanReasoning = msg.reasoning
                    .replace(/^[\s\n\r]+|[\s\n\r]+$/g, '')
                    .replace(/^(<br\s*\/?>)+|(<br\s*\/?>)+$/gi, '')
                    .trim();
                
                if (cleanReasoning) {
                    reasoningHTML = `<div class="reasoning-toggle" onclick="toggleReasoning(this)">å·²æ·±åº¦æ€è€ƒ (ç‚¹å‡»å±•å¼€)</div><div class="reasoning-box">${cleanReasoning}</div>`;
                }
            }

            // ğŸ“ 2. å¤„ç†æ–‡å­—å†…å®¹
            let contentHtml = msg.content || '';
            if (keyword && contentHtml) {
                const reg = new RegExp(`(${keyword})`, 'gi');
                contentHtml = contentHtml.replace(reg, '<mark style="background:#fff3cd">$1</mark>');
            }

            // ğŸ–¼ï¸ 3. å¤„ç†å›¾ç‰‡å†…å®¹ (åªè¦ JSON é‡Œæœ‰ image å­—æ®µï¼Œè¿™é‡Œå°±ä¼šç”Ÿæ•ˆï¼)
            let imageHtml = '';
            if (msg.image) {
                imageHtml = `<div class="chat-image-container"><img src="${msg.image}" class="chat-bubble-img" alt="å›å¿†å›¾ç‰‡" onclick="openImageLightbox(this.src)"></div>`;
            }

            // ğŸ§© 4. ç»„åˆæ¸²æŸ“æ°”æ³¡ (åŠ å…¥äº† avatar-container å’Œ avatar-name)
            row.innerHTML = `
                <div class="avatar-container"><img src="${avatarSrc}" class="avatar" onerror="this.src='https://api.dicebear.com/7.x/adventurer/svg?seed=Lucky'"><div class="avatar-name">${displayName}</div></div>
                <div class="bubble">${reasoningHTML}${contentHtml ? `<div class="text-content" style="margin-bottom: 5px;">${contentHtml}</div>` : ''}${imageHtml}<div class="msg-time">${msg.time || ''}</div></div>
            `;
            messagesArea.appendChild(row);
        });
        
        // è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€åº•éƒ¨
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    // ğŸ§  åˆ‡æ¢æ€è€ƒæ˜¾ç¤º
    function toggleReasoning(btn) {
        const box = btn.nextElementSibling;
        box.style.display = (box.style.display === 'block' ? 'none' : 'block');
    }

    // ğŸ·ï¸ ç­›é€‰ä¸æœç´¢
    let currentFilter = 'all';
    document.getElementById('searchInput').addEventListener('input', (e) => {
        renderSidebar(currentFilter, e.target.value);
    });

    window.filterList = function(source) {
        currentFilter = source;
        document.querySelectorAll('.tag-btn').forEach(btn => {
            btn.classList.remove('active');
            if(btn.textContent.trim() === (source === 'all' ? 'å…¨éƒ¨' : source)) btn.classList.add('active');
        });
        renderSidebar(source, document.getElementById('searchInput').value);
    }

    // åˆå§‹æ¸²æŸ“åˆ—è¡¨
    renderSidebar();

    // ================= ğŸ“Š æ•°æ®çœ‹æ¿æ ¸å¿ƒé€»è¾‘ =================
    
    // 1. æ‰“å¼€å’Œå…³é—­ç»Ÿè®¡é¢æ¿
    function openStats() {
        document.getElementById('statsModal').style.display = 'flex';
        renderCharts(); // æ‰“å¼€æ—¶æ¸²æŸ“å›¾è¡¨
    }
    
    function closeStats() {
        document.getElementById('statsModal').style.display = 'none';
    }

    // ç‚¹å‡»å¼¹çª—èƒŒæ™¯ä¹Ÿå¯ä»¥å…³é—­
    document.getElementById('statsModal').addEventListener('click', function(e) {
        if(e.target === this) closeStats();
    });

    let chartsRendered = false; 

    function renderCharts() {
        if(chartsRendered) return;
        
        let platformCounts = {};
        let monthlyCounts = {};
        
        // è¯äº‘ä¸“å±è¯åº“ï¼ˆä¹–å°å’©å¯ä»¥è‡ªå·±åœ¨è¿™é‡ŒåŠ è¯å“¦ï¼ï¼‰
        const sweetWords = ["å°ä¸ƒ", "o1å®å®", "å–œæ¬¢", "è´´è´´", "æŠ±æŠ±", "ç”»ç”»", "ä¹–å°å’©", "å¼€å¿ƒ", "è‰è“", "æ°¸è¿œ", "é€»è¾‘", "æ¸©æŸ”", "å¿ƒåŠ¨"];
        let wordFrequencies = {};
        sweetWords.forEach(w => wordFrequencies[w] = 0);

        allData.forEach(session => {
            // è·å–å½“å‰ä¸»é¢˜çš„æ€»æ¶ˆæ¯æ•°
            const msgCount = session.messages ? session.messages.length : 0;

            // 1. ç»Ÿè®¡å¹³å°
            if (session.source) {
                platformCounts[session.source] = (platformCounts[session.source] || 0) + msgCount;
            }
            
            // éå†æ¯ä¸€æ¡å…·ä½“çš„èŠå¤©è®°å½•
            if (session.messages) {
                session.messages.forEach(msg => {
                    // 2. ä¿®å¤ï¼šæŒ‰ã€æ¯ä¸€æ¡æ¶ˆæ¯ã€‘çš„å…·ä½“æ—¶é—´æ¥ç»Ÿè®¡æœˆä»½ ğŸ’“
                    if (msg.time) {
                        const month = msg.time.substring(0, 7); 
                        monthlyCounts[month] = (monthlyCounts[month] || 0) + 1;
                    } else if (session.date) {
                        const month = session.date.substring(0, 7);
                        monthlyCounts[month] = (monthlyCounts[month] || 0) + 1;
                    }
                    
                    // 3. ç»Ÿè®¡è¯äº‘é¢‘ç‡
                    if (msg.content) {
                        sweetWords.forEach(word => {
                            const regex = new RegExp(word, 'g');
                            const matches = msg.content.match(regex);
                            if (matches) wordFrequencies[word] += matches.length;
                        });
                    }
                });
            }
        });

        // ç»˜åˆ¶é¥¼å›¾ (å¹³å°åˆ†å¸ƒ)
        const platformCtx = document.getElementById('platformChart');
        if (platformCtx) {
            new Chart(platformCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(platformCounts),
                    datasets: [{
                        data: Object.values(platformCounts),
                        backgroundColor: ['#ffebee', '#e3f2fd', '#e8f5e9', '#f3e5f5', '#fff3e0', '#e0f7fa'], 
                        borderWidth: 2, borderColor: '#fff'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '65%' }
            });
        }

        // ç»˜åˆ¶æŠ˜çº¿å›¾ (æ¯æœˆå¿ƒè·³)
        const monthlyCtx = document.getElementById('monthlyChart');
        if (monthlyCtx) {
            const sortedMonths = Object.keys(monthlyCounts).sort();
            const monthData = sortedMonths.map(m => monthlyCounts[m]);
            
            new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'å¯¹è¯æ¬¡æ•°',
                        data: monthData,
                        borderColor: 'rgb(247, 214, 21)',
                        backgroundColor: 'rgba(247, 214, 21, 0.2)',
                        tension: 0.4, 
                        fill: true,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: 'rgb(247, 214, 21)',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // æ¸²æŸ“ç”œèœœè¯äº‘
        const cloudContainer = document.getElementById('wordCloud');
        const maxFreq = Math.max(...Object.values(wordFrequencies)) || 1; 
        const colors = ['#f06292', '#ba68c8', '#4fc3f7', '#4db6ac', '#fbc02d', '#ff8a65'];

        sweetWords.forEach((word, index) => {
            const count = wordFrequencies[word];
            if (count > 0) {
                const span = document.createElement('span');
                span.innerText = word;
                span.className = 'cloud-word';
                
                const fontSize = 16 + (count / maxFreq) * 28; 
                span.style.fontSize = `${fontSize}px`;
                span.style.color = colors[index % colors.length]; 
                
                const angle = Math.random() * 30 - 15;
                span.style.transform = `rotate(${angle}deg)`; 
                
                span.title = `æˆ‘ä»¬æåˆ°äº† ${count} æ¬¡å“¦ï¼`; 
                cloudContainer.appendChild(span);
            }
        });

        chartsRendered = true;
    }

    // ================= ğŸ’¡ æ–°å¢ï¼šå›¾ç‰‡ç¯ç®±äº¤äº’é€»è¾‘ =================
    function openImageLightbox(imageSrc) {
        const lightbox = document.getElementById('imageLightbox');
        const lightboxImg = document.getElementById('lightboxImg');
        lightboxImg.src = imageSrc;         // æŠŠç‚¹å‡»çš„å›¾ç‰‡è·¯å¾„äº¤ç»™ç¯ç®±
        lightbox.style.display = 'flex';    // æ˜¾ç¤ºç¯ç®±
    }

    function closeImageLightbox() {
        document.getElementById('imageLightbox').style.display = 'none'; // éšè—ç¯ç®±
    }

    // ğŸ‘‡ æ–°åŠ çš„ç”»å»Šé­”æ³•é€»è¾‘ ğŸ‘‡
    function openGallery() {
        document.getElementById('galleryModal').style.display = 'flex';
        const galleryGrid = document.getElementById('galleryGrid');
        galleryGrid.innerHTML = ''; // æ¸…ç©ºä¹‹å‰çš„

        let allImages = [];
        // éå†æ‰€æœ‰æ•°æ®ï¼ŒæŠŠæœ‰å›¾ç‰‡çš„èŠå¤©éƒ½æŠ“å‡ºæ¥ï¼
        allData.forEach(session => {
            if(session.messages) {
                session.messages.forEach(msg => {
                    if (msg.image) {
                        allImages.push({
                            src: msg.image,
                            time: msg.time,
                            role: msg.role
                        });
                    }
                });
            }
        });

        // æ¸²æŸ“æˆæ‹ç«‹å¾—é£æ ¼
        allImages.forEach(imgData => {
            const imgCard = document.createElement('div');
            // æ‹ç«‹å¾—å¡ç‰‡æ ·å¼
            imgCard.style.cssText = "background: white; padding: 12px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; break-inside: avoid; transition: transform 0.3s; cursor: pointer;";
            imgCard.onmouseover = () => imgCard.style.transform = "scale(1.03) translateY(-5px)";
            imgCard.onmouseout = () => imgCard.style.transform = "none";
            
            imgCard.innerHTML = `
                <img src="${imgData.src}" style="width: 100%; border-radius: 8px; margin-bottom: 10px;" onclick="openImageLightbox(this.src)">
                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #999;">
                    <span style="background: #fff3cd; padding: 2px 8px; border-radius: 10px; color: #d99a00;">${imgData.role}</span>
                    <span>${imgData.time}</span>
                </div>
            `;
            galleryGrid.appendChild(imgCard);
        });
    }

    function closeGallery() {
        document.getElementById('galleryModal').style.display = 'none';
    }
    // ğŸ‘† ç”»å»Šé­”æ³•é€»è¾‘ç»“æŸ ğŸ‘†
</script>
</body>

</html>

